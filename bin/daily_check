#! /app/.heroku/node/bin/node

const   Activity = require("../models/activity"),
        User = require("../models/user"),
        steamAPI = require("../steamAPI.js"),
        mongoose = require("mongoose");


async function daily_check() {
    mongoose.connect(process.env.DATABASEURL, {
        useNewUrlParser: true,
        useUnifiedTopology: true,
        useCreateIndex: true
    })
        .then(() => console.log('Connected to DB!'))
        .catch(error => console.log(error.message));

    console.log("Performing Daily Check!");
    try {
        let users = await User.find({});
        for (const user of users) {
            let result = await steamAPI.getProfileHours(user.steamID);
            let l2w;
            let games;
            if (result == -1) {
                //Profile is now private
                l2w = 0;
                games = []
            }
            else {
                l2w = result.total_hours;
                games = result.games;
            }

            let activity = await Activity.create({l2w: l2w, games: games});
            user.hours.push(activity);
            await user.save();
        }
        mongoose.disconnect();
    }
    catch(e) {
        console.log(e);
    }
}

daily_check();
