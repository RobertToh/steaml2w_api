#! /app/.heroku/node/bin/node

const   Activity = require("../models/activity"),
        User = require("../models/user"),
        scraper = require("../scraper.js"),
        mongoose = require("mongoose");


async function daily_check() {
    mongoose.connect(process.env.DATABASEURL, {
        useNewUrlParser: true,
        useUnifiedTopology: true,
        useCreateIndex: true
    })
        .then(() => console.log('Connected to DB!'))
        .catch(error => console.log(error.message));

    console.log("Performing Daily Check!");
    try {
        let users = await User.find({});
        for (const user of users) {
            let result = await scraper.getProfileHours("https://steamcommunity.com/profiles/" + user.steamID);
            let l2w;
            if (result == -1) {
                //Profile link is no longer valid, or profile is private
                
                result = await scraper.getProfileHours("https://steamcommunity.com/id/" + user.steamID);
                if (result == -1) {
                    //Profile link is no longer valid, or profile is private
                    l2w = 0;
                }
                else {
                    l2w = result;
                }
            }
            else {
                l2w = result;
            }

            let activity = await Activity.create({l2w: result});
            user.hours.push(activity);
            await user.save();
        }
        mongoose.disconnect();
    }
    catch(e) {
        console.log(e);
    }
}

daily_check();
